<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bluetooth Headphones Audio Bug</title>
  <script src="https://cdn.jsdelivr.net/npm/vconsole@latest/dist/vconsole.min.js"></script>
</head>
<body>
    <main>
        <header>
            <h1>iOS Capture Microphone Cause Bluetooth Headphone Not Working</h1>
            
            <section class="bug-summary">
                <p>
                    When capturing the microphone on iOS devices, the volume of Bluetooth headphones will stop working.
                </p>
                <p>
                    <strong>Environment:</strong> iPhone 15 Pro Max (iOS 18.2, Chrome 131); iPhone 12 Pro (iOS 17.6, Chrome 131)<br>
                    <strong>Reference:</strong> <a href="https://bugs.webkit.org/show_bug.cgi?id=285164" target="_blank" rel="noopener noreferrer">WebKit Bug #285164</a>
                </p>
            </section>
        </header>

        <section class="reproduction-steps">
            <h2>Reproduction Steps</h2>
            <ol>
                <li>Connect Bluetooth headphones</li>
                <li>Click "Play Music" button</li>
                <li>Select microphone device (optional, will use default microphone if not selected)</li>
                <li>Click "Open Microphone" button</li>
                <li>Observe if music switches from Bluetooth headphones to device speakers</li>
            </ol>

            <div class="controls">
                <button onclick="playMusic()" aria-label="Play background music">Play Music</button>
                
                <div class="microphone-controls">
                    <label for="micSelect">Select Microphone Device:</label>
                    <select id="micSelect" aria-label="Microphone device selection">
                        <option value="">Select Microphone (will use default if not selected)</option>
                    </select>
                </div>
                
                <button onclick="openMic()" aria-label="Start microphone capture">Open Microphone</button>
                
                <div id="microphoneList" class="microphone-list"></div>
            </div>
        </section>
    </main>

    <script>
        var vConsole = new VConsole();

        let currentStream = null;
        let microphoneList = [];

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const constraints = { audio: true };
                console.log('[getUserMedia] Initial request with constraints:', JSON.stringify(constraints));
                const initialStream = await navigator.mediaDevices.getUserMedia(constraints);
                initialStream.getTracks().forEach(track => track.stop());
                getMicrophones();
            } catch (error) {
                console.error('[getUserMedia] Failed to initialize microphone:', error);
            }
        });

        navigator.mediaDevices.addEventListener('devicechange', () => {
            console.log('[devicechange] Device change detected, refreshing microphone list');
            getMicrophones();
        });

        async function getMicrophones() {
            const devices = await navigator.mediaDevices.enumerateDevices();
            microphoneList = devices.filter(device => device.kind === 'audioinput');
            console.log('[enumerateDevices] Audio input devices:', microphoneList.map(m => ({
                deviceId: m.deviceId,
                label: m.label
            })));
            const micSelect = document.getElementById('micSelect');
            const micListContainer = document.getElementById('microphoneList');
            const previousSelection = micSelect.value;
            
            while (micSelect.options.length > 1) {
                micSelect.remove(1);
            }
            
            microphoneList.forEach(mic => {
                const option = document.createElement('option');
                option.value = mic.deviceId;
                option.text = mic.label || `Microphone ${micSelect.options.length}`;
                micSelect.appendChild(option);
            });

            if (previousSelection && microphoneList.some(m => m.deviceId === previousSelection)) {
                micSelect.value = previousSelection;
            }

            micListContainer.innerHTML = '<h3>Available Microphones:</h3><ul>';
            microphoneList.forEach((mic, index) => {
                const li = document.createElement('li');
                li.textContent = `${index + 1}. ${mic.label || `Microphone ${index + 1}`} (ID: ${mic.deviceId})`;
                micListContainer.querySelector('ul').appendChild(li);
            });
            micListContainer.innerHTML += '</ul>';
        }

        function playMusic() {
            const audio = new Audio('./bgm.mp3');
            audio.controls = true;
            audio.autoplay = true;
            audio.loop = true;
            audio.play().catch(error => console.error('Failed to play music:', error));
            document.body.appendChild(audio);
        }

        async function openMic() {
            const micSelect = document.getElementById('micSelect');
            const deviceId = micSelect.value;

            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }

            try {
                let constraints;
                if (deviceId) {
                    constraints = {
                        audio: {
                            deviceId: { exact: deviceId }
                        }
                    };
                } else {
                    constraints = { audio: true };
                }
                console.log('[getUserMedia] Requesting with constraints:', JSON.stringify(constraints));
                
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                const track = currentStream.getAudioTracks()[0];
                console.log('[getUserMedia] Stream obtained, device:', track ? track.getSettings().deviceId : 'unknown');
            } catch (error) {
                console.error('[getUserMedia] Failed to open microphone:', error);
                alert('Failed to open microphone');
            }
        }
    </script>
</body>
</html> 